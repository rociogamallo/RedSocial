<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bookser - Intercambio de Libros</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/index.css">
</head>
<body>
    <nav class="sidebar">
        <a href="index.html"><i class="fas fa-home"></i> Inicio</a>
        <a href="buscador.html"><i class="fas fa-search"></i> Buscar</a>
        <a href="chats.html"><i class="fas fa-envelope"></i> Mensajes</a>
        <a href="perfil.html"><i class="fas fa-user"></i> Perfil</a>
        <a href="logout.html"><i class="fas fa-sign-out-alt"></i> Cerrar sesi√≥n</a>
    </nav>
    
    <div class="container-wrapper">
        <div class="welcome-banner">
            <h1>¬°Bienvenido a Bookser!</h1>
            <p>Descubre, comparte e intercambia libros con personas de tu comunidad. Una segunda vida para tus libros favoritos y nuevas historias por descubrir.</p>
            <div class="search-bar">
                <input type="text" id="searchInput" placeholder="Busca por t√≠tulo, autor o g√©nero...">
                <button id="searchBtn"><i class="fas fa-search"></i></button>
            </div>
        </div>
        
        <div class="categories">
            <div class="category-tag active">Todos</div>
            <div class="category-tag">Ficci√≥n</div>
            <div class="category-tag">No ficci√≥n</div>
            <div class="category-tag">Misterio</div>
            <div class="category-tag">Ciencia ficci√≥n</div>
            <div class="category-tag">Fantas√≠a</div>
            <div class="category-tag">Romance</div>
            <div class="category-tag">Thriller</div>
            <div class="category-tag">Biograf√≠a</div>
            <div class="category-tag">Historia</div>
            <div class="category-tag">Autoayuda</div>
            <div class="category-tag">Poes√≠a</div>
            <div class="category-tag">Otro</div>
        </div>        
        
        <h2 class="section-title"><i class="fas fa-fire"></i> A√±adidos recientemente</h2>
        <div class="books-grid" id="booksGrid"></div>

    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            let booksData = [];
    
            // üìö Cargar libros al iniciar
            loadBooks();
    
            async function loadBooks() {
                try {
                    const response = await fetch("http://localhost:3000/libros");
                    booksData = await response.json();
                    displayBooks(booksData);
                } catch (error) {
                    console.error("Error cargando libros:", error);
                }
            }
    
            function displayBooks(books) {
                const booksGrid = document.querySelector(".books-grid");
                booksGrid.innerHTML = ""; // Limpiar antes de agregar nuevos libros
    
                const userEmail = localStorage.getItem("userEmail"); // Obtener el email del usuario logueado desde el token
    
                books.forEach(book => {
                    // Verificar si el libro tiene t√≠tulo, y si el email del propietario no coincide con el usuario logueado
                    if (!book.titulo || book.email === userEmail) {
                        return; // No mostrar el libro si no tiene t√≠tulo o es del usuario logueado
                    }
    
                    const bookCard = document.createElement("div");
                    bookCard.classList.add("book-card");
    
                    const propietarioNombre = book.propietarioMote || book.propietario;  // Usar el mote si existe, si no, el nombre completo
                    const propietarioFoto = book.propietarioFoto || '/img/libro.png';  // Usar foto de propietario si existe
    
                    bookCard.innerHTML = `
                        <div class="book-cover" style="background-image: url('${book.portada || '/img/default.png'}')"></div>
                        <div class="book-info">
                            <div class="book-title">${book.titulo}</div>
                            <div class="book-author">${book.autor}</div>
                            <a href="#" class="request-btn" data-owner-email="${book.email}">Solicitar intercambio</a>
                        </div>
                    `;
    
                    booksGrid.appendChild(bookCard);
                });
            }
    
            // üîç Buscar libros en tiempo real
            document.querySelector(".search-bar input").addEventListener("input", async function () {
                const searchTerm = this.value.toLowerCase();
                
                if (searchTerm === "") {
                    displayBooks(booksData); // Si est√° vac√≠o, mostrar todos
                    return;
                }
    
                try {
                    const response = await fetch(`http://localhost:3000/buscar?q=${searchTerm}`);
                    const filteredBooks = await response.json();
                    displayBooks(filteredBooks);
                } catch (error) {
                    console.error("Error en la b√∫squeda:", error);
                }
            });
    
            // üéØ Filtrar por categor√≠as
            document.querySelectorAll(".category-tag").forEach(category => {
                category.addEventListener("click", function () {
                    document.querySelectorAll(".category-tag").forEach(tag => tag.classList.remove("active"));
                    this.classList.add("active");
    
                    const selectedCategory = this.innerText;
                    if (selectedCategory === "Todos") {
                        displayBooks(booksData);
                    } else {
                        const filteredBooks = booksData.filter(book => book.genero === selectedCategory);
                        displayBooks(filteredBooks);
                    }
                });
            });
            document.querySelector(".search-bar input").addEventListener("input", async function () {
                const searchTerm = this.value.toLowerCase();
                
                if (searchTerm === "") {
                    displayBooks(booksData); // Si est√° vac√≠o, mostrar todos
                    return;
                }

                try {
                    const response = await fetch(`http://localhost:3000/buscar?q=${searchTerm}`);
                    const filteredBooks = await response.json();
                    displayBooks(filteredBooks);
                } catch (error) {
                    console.error("Error en la b√∫squeda:", error);
                }
            });

    
            // Script para manejar el clic en el bot√≥n de solicitud de intercambio
            document.addEventListener("DOMContentLoaded", function () {
                const requestButtons = document.querySelectorAll(".request-btn");
    
                requestButtons.forEach(button => {
                    button.addEventListener("click", function (event) {
                        event.preventDefault();
                        const ownerEmail = button.getAttribute("data-owner-email"); // Obtener el email del propietario
                        localStorage.setItem("bookOwnerEmail", ownerEmail); // Guardar el email del propietario
                        window.location.href = "messages.html"; // Redirige al chat
                    });
                });
            });
        });
    </script>
    
</body>
</html>
