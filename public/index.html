<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bookser - Intercambio de Libros</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/index.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
</head>
<body>
    <nav class="sidebar">
        <a href="index.html"><i class="fas fa-home"></i> Inicio</a>
        <a href="buscador.html"><i class="fas fa-search"></i> Buscar</a>
        <a href="chatsList.html"><i class="fas fa-envelope"></i> Mensajes</a>
        <a href="perfil.html"><i class="fas fa-user"></i> Perfil</a>
        <a href="logout.html"><i class="fas fa-sign-out-alt"></i> Cerrar sesi√≥n</a>
    </nav>
    
    <div class="container-wrapper">
        <div class="welcome-banner">
            <h1>¬°Bienvenido a Bookser!</h1>
            <p>Descubre, comparte e intercambia libros con personas de tu comunidad. Una segunda vida para tus libros favoritos y nuevas historias por descubrir.</p>
            <div class="search-bar">
                <input type="text" id="searchInput" placeholder="Busca por t√≠tulo, autor o g√©nero...">
                <button id="searchBtn"><i class="fas fa-search"></i></button>
            </div>
        </div>
        
        <div class="categories">
            <div class="category-tag active">Todos</div>
            <div class="category-tag">Ficci√≥n</div>
            <div class="category-tag">No ficci√≥n</div>
            <div class="category-tag">Misterio</div>
            <div class="category-tag">Ciencia ficci√≥n</div>
            <div class="category-tag">Fantas√≠a</div>
            <div class="category-tag">Romance</div>
            <div class="category-tag">Thriller</div>
            <div class="category-tag">Biograf√≠a</div>
            <div class="category-tag">Historia</div>
            <div class="category-tag">Autoayuda</div>
            <div class="category-tag">Poes√≠a</div>
            <div class="category-tag">Otro</div>
        </div>        
        
        <h2 class="section-title"><i class="fas fa-fire"></i> A√±adidos recientemente</h2>
        <div class="books-grid" id="booksGrid"></div>

    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            let booksData = [];
    
            // üìö Cargar libros al iniciar
            loadBooks();
    
            async function loadBooks() {
                try {
                    const response = await fetch("http://localhost:3000/libros");
                    booksData = await response.json();
                    displayBooks(booksData);
                } catch (error) {
                    console.error("Error cargando libros:", error);
                }
            }
    
            function displayBooks(books) {
                const booksGrid = document.querySelector(".books-grid");
                booksGrid.innerHTML = ""; // Limpiar antes de agregar nuevos libros
    
                const userEmail = localStorage.getItem("userEmail"); // Obtener el email del usuario logueado desde el token
    
                books.forEach(book => {
                    // Verificar si el libro tiene t√≠tulo, y si el email del propietario no coincide con el usuario logueado
                    if (!book.titulo || book.email === userEmail) {
                        return; // No mostrar el libro si no tiene t√≠tulo o es del usuario logueado
                    }
    
                    const bookCard = document.createElement("div");
                    bookCard.classList.add("book-card");
    
                    const propietarioNombre = book.propietarioMote || book.propietario;  // Usar el mote si existe, si no, el nombre completo
                    const propietarioFoto = book.propietarioFoto || '/img/libro.png';  // Usar foto de propietario si existe
    
                    bookCard.innerHTML = `
                        <div class="book-cover" style="background-image: url('${book.portada || '/img/default.png'}')"></div>
                        <div class="book-info">
                            <div class="book-title">${book.titulo}</div>
                            <div class="book-author">${book.autor}</div>
                            <a href="#" class="request-btn" data-owner-email="${book.email}">Solicitar intercambio</a>
                        </div>
                    `;
    
                    booksGrid.appendChild(bookCard);
                });
            }
    
            // üîç Buscar libros en tiempo real
            document.querySelector(".search-bar input").addEventListener("input", async function () {
                const searchTerm = this.value.toLowerCase();
                
                if (searchTerm === "") {
                    displayBooks(booksData); // Si est√° vac√≠o, mostrar todos
                    return;
                }
    
                try {
                    const response = await fetch(`http://localhost:3000/buscar?q=${searchTerm}`);
                    const filteredBooks = await response.json();
                    displayBooks(filteredBooks);
                } catch (error) {
                    console.error("Error en la b√∫squeda:", error);
                }
            });
    
            // üéØ Filtrar por categor√≠as
            document.querySelectorAll(".category-tag").forEach(category => {
                category.addEventListener("click", function () {
                    document.querySelectorAll(".category-tag").forEach(tag => tag.classList.remove("active"));
                    this.classList.add("active");
    
                    const selectedCategory = this.innerText;
                    if (selectedCategory === "Todos") {
                        displayBooks(booksData);
                    } else {
                        const filteredBooks = booksData.filter(book => book.genero === selectedCategory);
                        displayBooks(filteredBooks);
                    }
                });
            });
            document.querySelector(".search-bar input").addEventListener("input", async function () {
                const searchTerm = this.value.toLowerCase();
                
                if (searchTerm === "") {
                    displayBooks(booksData); // Si est√° vac√≠o, mostrar todos
                    return;
                }

                try {
                    const response = await fetch(`http://localhost:3000/buscar?q=${searchTerm}`);
                    const filteredBooks = await response.json();
                    displayBooks(filteredBooks);
                } catch (error) {
                    console.error("Error en la b√∫squeda:", error);
                }
            });

    
           // Reemplaza el evento de click para los botones de solicitud en prueba index.html
        document.addEventListener("click", function(event) {
            if (event.target.classList.contains('request-btn')) {
                event.preventDefault();
                
                const ownerEmail = event.target.getAttribute('data-owner-email');
                const userEmail = localStorage.getItem("userEmail");
                
                if (!userEmail) {
                    alert("Debes iniciar sesi√≥n para solicitar un libro");
                    window.location.href = "login.html";
                    return;
                }
                
                // Iniciar chat con el propietario
                startChatWithUser(userEmail, ownerEmail);
            }
        });

        // Funci√≥n para iniciar chat con otro usuario
        async function startChatWithUser(currentUserEmail, otherUserEmail) {
            try {
                // Configuraci√≥n de Firebase (aseg√∫rate de que esto est√© definido en tu p√°gina)
                const firebaseConfig = {
                    apiKey: "AIzaSyBgf6uDmurevI9MSV-gGgR_EmNFWHILsWs",
                    authDomain: "libros-9d5d4.firebaseapp.com",
                    projectId: "libros-9d5d4",
                    storageBucket: "libros-9d5d4.appspot.com",
                    messagingSenderId: "802623661541",
                    appId: "1:802623661541:web:5bce5122460c335c4ebb0c"
                };

                // Inicializar Firebase si no est√° inicializado
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                
                const db = firebase.firestore();
                
                // Comprobar si ya existe un chat entre estos usuarios
                const existingChatsQuery = await db.collection('chats')
                    .where('participantes', 'array-contains', currentUserEmail)
                    .get();
                
                let existingChatId = null;
                
                existingChatsQuery.forEach(doc => {
                    const chatData = doc.data();
                    if (chatData.participantes.includes(otherUserEmail)) {
                        existingChatId = doc.id;
                    }
                });
                
                // Si ya existe un chat, ir a ese chat
                if (existingChatId) {
                    window.location.href = `messages.html?chatId=${existingChatId}&otherEmail=${otherUserEmail}`;
                    return;
                }
                
                // Si no existe, crear nuevo chat
                const newChatRef = await db.collection('chats').add({
                    participantes: [currentUserEmail, otherUserEmail],
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastMessageTime: firebase.firestore.FieldValue.serverTimestamp(),
                    lastMessage: "",
                    unreadCount: {
                        [currentUserEmail]: 0,
                        [otherUserEmail]: 0
                    }
                });
                
                // Redirigir al chat reci√©n creado
                window.location.href = `messages.html?chatId=${newChatRef.id}&otherEmail=${otherUserEmail}`;
                
            } catch (error) {
                console.error('Error al crear nuevo chat:', error);
                alert('Error al crear el chat. Por favor, int√©ntalo de nuevo.');
            }
        }

        });

        // Configurar escucha global para notificaciones de chat
        function setupGlobalNotifications() {
            if (!currentUser) return;
            
            // Escuchar cambios en todos los chats donde el usuario es participante
            const chatsQuery = db.collection('chats')
                .where('participantes', 'array-contains', currentUser.email);
            
            const unsubscribe = chatsQuery.onSnapshot(snapshot => {
                snapshot.docChanges().forEach(change => {
                    if (change.type === 'modified') {
                        const chatData = change.doc.data();
                        const chatId = change.doc.id;
                        
                        // Verificar si hay mensajes no le√≠dos para el usuario actual
                        const unreadCount = chatData.unreadCount && chatData.unreadCount[currentUser.email] || 0;
                        
                        if (unreadCount > 0 && !window.location.href.includes('messages.html')) {
                            // Obtener el otro participante
                            const otherUserEmail = chatData.participantes.find(email => email !== currentUser.email);
                            
                            // Obtener informaci√≥n del otro usuario
                            db.collection('users').where('email', '==', otherUserEmail).get()
                                .then(snapshot => {
                                    if (!snapshot.empty) {
                                        const userData = snapshot.docs[0].data();
                                        const userName = userData.nombre && userData.apellidos ? 
                                            `${userData.nombre} ${userData.apellidos}` : otherUserEmail;
                                        const userPhoto = userData.foto || 'img/default.png';
                                        
                                        // Mostrar notificaci√≥n
                                        showNotification(
                                            `Nuevo mensaje de ${userName}`, 
                                            chatData.lastMessage || 'Tienes un nuevo mensaje', 
                                            userPhoto,
                                            function() {
                                                // Al hacer clic, ir a la p√°gina de mensajes con este chat
                                                window.location.href = `messages.html?chatId=${chatId}&otherEmail=${otherUserEmail}`;
                                            }
                                        );
                                    }
                                });
                        }
                    }
                });
            });
            
            // Guardar la funci√≥n de cancelaci√≥n
            window.globalNotificationsUnsubscribe = unsubscribe;
        }

        // Llamar a esta funci√≥n cuando el usuario inicie sesi√≥n
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                setupGlobalNotifications();
                // Resto de tu c√≥digo...
            }
        });

        // Registrar el Service Worker para notificaciones push
        if ('serviceWorker' in navigator && 'PushManager' in window) {
        navigator.serviceWorker.register('/service-worker.js')
            .then(function(registration) {
            console.log('Service Worker registrado con √©xito:', registration);
            
            // Solicitar permiso para notificaciones
            return requestNotificationPermission();
            })
            .then(function(permission) {
            if (permission) {
                // Obtener la suscripci√≥n push
                return navigator.serviceWorker.ready.then(function(registration) {
                return registration.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: urlBase64ToUint8Array('BK3dQwXI_qONBKYUHkooFbPXmQeewtjN0QhK1kBpVFBuM0wid5uD34Ttspm1Fo3RjO1GJTKHEV_LNFjGAbuHIRk')
                });
                });
            }
            })
            .then(function(subscription) {
            if (subscription) {
                // Enviar la suscripci√≥n al servidor
                return fetch('/api/subscribe', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                },
                body: JSON.stringify(subscription)
                });
            }
            })
            .catch(function(error) {
            console.error('Error al registrar el Service Worker:', error);
            });
        }

        // Funci√≥n auxiliar para convertir la clave VAPID
        function urlBase64ToUint8Array(base64String) {
        const padding = '='.repeat((4 - base64String.length % 4) % 4);
        const base64 = (base64String + padding)
            .replace(/-/g, '+')
            .replace(/_/g, '/');

        const rawData = window.atob(base64);
        const outputArray = new Uint8Array(rawData.length);

        for (let i = 0; i < rawData.length; ++i) {
            outputArray[i] = rawData.charCodeAt(i);
        }
        return outputArray;
        }
    </script>
    
</body>
</html>
