<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfil de Usuario</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        body {
            background-color: #f8f9fa;
            display: flex;
        }
        .sidebar {
            width: 250px;
            height: 100vh;
            background: white;
            padding: 2rem 1rem;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
            position: fixed;
            top: 0;
            left: 0;
            overflow-y: auto;
        }
        .sidebar a {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            margin-bottom: 10px;
            text-decoration: none;
            color: black;
            font-weight: bold;
            border-radius: 5px;
        }
        .sidebar a:hover {
            background-color: #e9ecef;
        }
        .container-wrapper {
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 5vh 0;
            margin-left: 250px;
        }
        .profile-container {
            width: 100%;
            max-width: 600px;
            padding: 2rem;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        .profile-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .profile-image {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 3px solid black;
            object-fit: cover;
        }
        .settings-icon {
            position: absolute;
            top: 15px;
            right: 15px;
            cursor: pointer;
            width: 5%;
        }
        .books-container {
            margin-top: 2rem;
        }
        .book-card {
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 15px;
            background: #fff;
        }
        .book-card .book-info {
            display: flex;
            flex-direction: row;
            gap: 15px;
        }
        .book-card .book-info img {
            width: 120px;
            height: 180px;
            border-radius: 5px;
            object-fit: cover;
        }
        .book-info-text {
            flex-grow: 1;
        }
        .book-info-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        .book-info-header h5 {
            margin: 0;
        }
        .book-actions {
            width: 100%;
            text-align: center;
            margin-top: 10px;
        }
        .book-actions button {
            width: 100%;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <nav class="sidebar">
        <a href="index.html"><i class="fas fa-home"></i> Inicio</a>
        <a href="buscador.html"><i class="fas fa-search"></i> Buscar</a>
        <a href="chats.html"><i class="fas fa-envelope"></i> Mensajes</a>
        <a href="perfil.html"><i class="fas fa-user"></i> Perfil</a>
        <a href="logout.html"><i class="fas fa-sign-out-alt"></i> Cerrar sesión</a>
    </nav>
    <div class="container-wrapper">
        <div class="profile-container">
            <div>
                <img src="./img/engranaje.png" alt="Ajustes" class="settings-icon" onclick="window.location.href='ajustes.html'">
                <div class="profile-header">
                    <img id="profileImage" src="/default.png" alt="Imagen de perfil" class="profile-image">
                    <div>
                        <h3 id="nombre"></h3>
                        <p id="descripcion" class="text-muted"></p>
                        <p><strong>Localidad:</strong> <span id="localidad"></span></p>
                    </div>
                </div>
                <div class="books-container">
                    <h4>Libros para Intercambio</h4>
                    <div id="booksList"></div>
                    <div class="text-center mt-3">
                        <a href="agregar_libros.html" class="btn btn-primary">Añadir más libros</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const token = localStorage.getItem('token');

            if (!token) {
                alert('No has iniciado sesión.');
                window.location.href = 'login.html';
                return;
            }

            try {
                const response = await fetch('http://localhost:3000/perfil', {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await response.json();

                if (response.ok) {
                    document.getElementById('profileImage').src = data.foto || '/default.png';
                    const nombreUsuario = data.mote && data.mote.trim() !== "" ? data.mote : `${data.nombre} ${data.apellidos}`;
                    document.getElementById('nombre').textContent = nombreUsuario;
                    document.getElementById('descripcion').textContent = data.descripcion;
                    document.getElementById('localidad').textContent = data.localidad;

                    const booksList = document.getElementById('booksList');
                    booksList.innerHTML = "";  

                    data.libros.forEach(libro => {
                        const isOwner = libro.ownerId === data.uid;

                        const bookCard = document.createElement('div');
                        bookCard.classList.add('book-card');

                        const bookDetails = document.createElement('div');
                        bookDetails.classList.add('book-info-header');
                        bookDetails.innerHTML = `
                            <h5>${libro.titulo} - ${libro.autor}</h5>
                            <i class="fas fa-caret-down"></i>
                        `;
                        bookDetails.addEventListener('click', () => {
                            const details = bookCard.querySelector('.book-info');
                            details.classList.toggle('d-none');
                        });

                        const bookInfo = document.createElement('div');
                        bookInfo.classList.add('book-info', 'd-none');
                        bookInfo.innerHTML = `
                            <img src="${libro.imagen}" alt="Imagen del libro">
                            <div class="book-info-text">
                                <p><strong>Género:</strong> ${libro.genero}</p>
                                <p><strong>Estado:</strong> ${libro.estado}</p>
                                <p><strong>Opinión:</strong> ${libro.resumen}</p>
                            </div>
                        `;

                        const bookActions = document.createElement('div');
                        bookActions.classList.add('book-actions');
                        bookActions.innerHTML = `
                            ${isOwner ? 
                                `<button class="btn btn-danger" onclick="borrarLibro('${libro.titulo}', '${token}')">Borrar</button>` :
                                `<button class="btn btn-success" onclick="interesado('${libro.titulo}', '${token}')">Lo quiero</button>`}
                        `;

                        bookCard.appendChild(bookDetails);
                        bookCard.appendChild(bookInfo);
                        bookCard.appendChild(bookActions);

                        booksList.appendChild(bookCard);
                    });

                } else {
                    alert('Error al cargar el perfil: ' + data.message);
                }
            } catch (error) {
                console.error('Error al obtener el perfil:', error);
            }
        });

        function interesado(libroId, token) {
            fetch(`http://localhost:3000/interesado/${libroId}`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` }
            })
            .then(res => res.json())
            .then(data => {
                alert('Te has interesado por este libro!');
                window.location.href = `chats.html?email=${data.email}`;
            });
        }

        function borrarLibro(tituloLibro, token) {
            // Asegúrate de que se recibe un token
            if (!token) {
                console.error('No tienes sesión iniciada');
                return;
            }

            // Crear el cuerpo de la solicitud
            const body = {
                tituloLibro: tituloLibro,
                email: localStorage.getItem('email')  // Obtén el email desde el localStorage si lo tienes guardado allí
            };

            fetch(`http://localhost:3000/borrarLibro/${encodeURIComponent(tituloLibro)}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
                })
                .then(response => {
                if (!response.ok) {
                    throw new Error('Error al borrar el libro');
                }
                return response.json();
                })
                .then(data => {
                console.log(data.message);  // Mostrar el mensaje de éxito
                alert('Libro eliminado');
                // Actualizar la lista de libros
                actualizarListaLibros(token);
                })
                .catch(error => {
                console.error('Error al eliminar el libro:', error);
                });
        }

        function actualizarListaLibros(token) {
  fetch('http://localhost:3000/perfil', {
    method: 'GET',
    headers: {
      'Authorization': `Bearer ${token}`,
    }
  })
  .then(response => response.json())
  .then(data => {
    // Actualizar la lista de libros en el DOM
    const booksList = document.getElementById('booksList');
    booksList.innerHTML = "";  // Limpiar la lista actual

    data.libros.forEach(libro => {
      const isOwner = libro.ownerId === data.uid;

      const bookCard = document.createElement('div');
      bookCard.classList.add('book-card');

      const bookDetails = document.createElement('div');
      bookDetails.classList.add('book-info-header');
      bookDetails.innerHTML = `
        <h5>${libro.titulo} - ${libro.autor}</h5>
        <i class="fas fa-caret-down"></i>
      `;
      bookDetails.addEventListener('click', () => {
        const details = bookCard.querySelector('.book-info');
        details.classList.toggle('d-none');
      });

      const bookInfo = document.createElement('div');
      bookInfo.classList.add('book-info', 'd-none');
      bookInfo.innerHTML = `
        <img src="${libro.imagen}" alt="Imagen del libro">
        <div class="book-info-text">
          <p><strong>Género:</strong> ${libro.genero}</p>
          <p><strong>Estado:</strong> ${libro.estado}</p>
          <p><strong>Opinión:</strong> ${libro.resumen}</p>
        </div>
      `;

      const bookActions = document.createElement('div');
      bookActions.classList.add('book-actions');
      bookActions.innerHTML = `
        ${isOwner ? 
            `<button class="btn btn-danger" onclick="borrarLibro('${libro.titulo}', '${token}')">Borrar</button>` :
            `<button class="btn btn-success" onclick="interesado('${libro.titulo}', '${token}')">Lo quiero</button>`}
      `;

      bookCard.appendChild(bookDetails);
      bookCard.appendChild(bookInfo);
      bookCard.appendChild(bookActions);

      booksList.appendChild(bookCard);
    });

  })
  .catch(error => console.error('Error al actualizar la lista de libros:', error));
}


    </script>
</body>
</html>
